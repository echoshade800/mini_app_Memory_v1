# 音效修复测试指南

## 问题描述
在第i关通关后没有等分数结算进度条充满就点击next进入第i+1关、quit到home界面、retry再玩一次第i关时，仍然会在第i+1关的preview环节和翻牌环节中听到结算进度条充满的d#6、g#6、a#6音效。

## 修复内容

### 1. SoundManager.js 增强
- 改进了 `stopLevelSounds()` 方法，现在会：
  - 停止播放
  - 重置位置到开始
  - 卸载音效实例
  - 清理音效实例引用
- 确保音效完全停止和清理

### 2. ScoreProgressBars.js 增强
- 在音效播放前增加了更严格的检查：
  - 检查停止标志
  - 检查音效实例是否仍然存在
- 改进了 `unloadSounds()` 方法：
  - 立即停止所有音效
  - 清理音效引用
  - 设置引用为null

### 3. ComboDisplay.js 增强
- 在音效播放前增加了更严格的检查
- 改进了 `unloadComboSounds()` 方法
- 确保连击音效也能正确停止

### 4. Game Screen 增强
- 在关卡初始化时重置音效管理器状态
- 在关卡切换时立即停止音效并等待完全停止
- 增加了延迟确保音效完全停止后再切换

### 5. Home Screen 增强
- 在进入主页时清理所有音效

## 测试步骤

### 测试场景1：Next按钮测试
1. 进入任意关卡（如第1关）
2. 完成关卡，看到分数结算页面
3. **不要等待进度条充满**，立即点击"Next"按钮
4. 进入下一关的preview环节
5. **预期结果**：不应该听到第1关的d#6、g#6、a#6音效
6. 在下一关的翻牌环节也不应该听到这些音效

### 测试场景2：Quit按钮测试
1. 进入任意关卡（如第1关）
2. 完成关卡，看到分数结算页面
3. **不要等待进度条充满**，立即点击"Quit"按钮
4. 返回主页
5. **预期结果**：在主页不应该听到第1关的d#6、g#6、a#6音效

### 测试场景3：Retry按钮测试
1. 进入任意关卡（如第1关）
2. 完成关卡，看到分数结算页面
3. **不要等待进度条充满**，立即点击"Retry"按钮
4. 重新开始同一关卡
5. **预期结果**：在重新开始的关卡中不应该听到之前关卡的d#6、g#6、a#6音效

### 测试场景4：正常音效测试
1. 进入任意关卡
2. 完成关卡，等待进度条完全充满
3. **预期结果**：应该正常听到d#6、g#6、a#6音效
4. 然后点击Next/Quit/Retry
5. **预期结果**：音效应该立即停止

## 验证方法

### 控制台日志检查
在测试过程中，应该看到以下日志：
- `🔊 SoundManager: Stopping sounds for level X...`
- `🔊 SoundManager: All sounds for level X stopped and cleaned up`
- `Game: Stopping sounds for level X`
- `Home: Cleaning up all sounds when entering home screen`

### 音效行为检查
- 关卡切换时音效应该立即停止
- 新关卡的音效应该正常播放
- 不应该在错误的关卡听到其他关卡的音效

## 修复原理

1. **立即停止机制**：在关卡切换时立即调用 `soundManager.stopLevelSounds()`
2. **彻底清理**：不仅停止播放，还卸载音效实例
3. **状态重置**：在新关卡开始时重置音效管理器状态
4. **延迟切换**：确保音效完全停止后再进行页面切换
5. **严格检查**：在音效播放前进行多重检查

这个修复确保了音效不会在关卡之间"泄漏"，解决了用户报告的问题。
